<form method="post">
    <div class="row">
        <div class="col col-md-8 left">
        	<div class="panel panel-customer panel-default clear">
            	<div class="panel-heading brand">
                    <div class="panel-title">Customer Info</div>
                </div>   
                 <div class="panel-body">
                 	<div class="form-group{{#if errors.profile_name}} has-error{{/if}}">
                        <label class="control-label">Customer Name</label>
                        <div class="form-fieldset">
                            <input 
                            type="text" 
                            name="profile_name" 
                            class="form-control" 
                            value="{{profile_name}}" />
                            {{#if errors.profile_name}}
                            <span class="help-text">{{errors.profile_name}}</span>
                            {{/if}}
                        </div>
                    </div>
                    
                 	<div class="form-group{{#if errors.profile_email}} has-error{{/if}}">
                        <label class="control-label">Email</label>
                        <div class="form-fieldset">
                            <input 
                            type="text" 
                            name="profile_email" 
                            class="form-control" 
                            value="{{profile_email}}" />
                            {{#if errors.profile_email}}
                            <span class="help-text">{{errors.profile_email}}</span>
                            {{/if}}
                        </div>
                    </div>
                    
                 	<div class="form-group{{#if errors.profile_phone}} has-error{{/if}}">
                        <label class="control-label">Phone</label>
                        <div class="form-fieldset">
                            <input 
                            type="text" 
                            name="profile_phone" 
                            class="form-control" 
                            value="{{profile_phone}}" />
                            {{#if errors.profile_phone}}
                            <span class="help-text">{{errors.profile_phone}}</span>
                            {{/if}}
                        </div>
                    </div>
                 </div>
            </div>
            
            <div class="panel panel-payment panel-default clear">
            	<div class="panel-heading brand">
                    <div class="panel-title">Payment Method</div>
                </div>   
                <div class="panel-body">
                	<div class="form-group{{#if errors.transaction_method}} has-error{{/if}}">
                    	<label class="control-label">Payment Method</label>
                        <div class="form-fieldset">
                            <select class="form-control" name="transaction_method">
                                <option value="">Choose a Payment Method</option>
                                {{#each gateways}}
                                {{#if checked}}
                                <option value="{{name}}">{{title}}</option>
                                {{/if}}
                                {{/each}}
                            </select>
                            {{#if errors.transaction_method}}
                            <span class="help-text">{{errors.transaction_method}}</span>
                            {{/if}}
                        </div>
                    </div>
                 </div>
            </div>
            
            {{#if checkout_shipping}}
            <div class="panel panel-shipping panel-default clear">
            	<div class="panel-heading brand">
                    <div class="panel-title">Shipping Address</div>
                </div>   
                 <div class="panel-body">
                 	{{#if address}}
                    <div class="form-group">
                    	<label class="control-label">Choose an Existing Address</label>
                        <div class="form-fieldset">
                            <select class="addresses form-control">
                                <option value="">Your Addresses</option>
                                {{#each address}}
                                <option value="{{@index}}">{{address_label}}</option>
                                {{/each}}
                            </select>
                        </div>
                    </div>
                    {{/if}}
                 
                 	<div class="form-group{{#if errors.address_street}} has-error{{/if}}">
                        <label class="control-label">Street</label>
                        <div class="form-fieldset">
                            <input 
                            type="text" 
                            name="address_street" 
                            class="form-control field-street" 
                            value="{{address_street}}" />
                            {{#if errors.address_street}}
                            <span class="help-text">{{errors.address_street}}</span>
                            {{/if}}
                        </div>
                    </div>
                    
                 	<div class="form-group{{#if errors.address_city}} has-error{{/if}}">
                        <label class="control-label">City</label>
                        <div class="form-fieldset">
                            <input 
                            type="text" 
                            name="address_city" 
                            class="form-control field-city" 
                            value="{{address_city}}" />
                            {{#if errors.address_city}}
                            <span class="help-text">{{errors.address_city}}</span>
                            {{/if}}
                        </div>
                    </div>
                    
                 	<div class="form-group{{#if errors.address_state}} has-error{{/if}}">
                        <label class="control-label">State</label>
                        <div class="form-fieldset">
                            <input 
                            type="text" 
                            name="address_state" 
                            class="form-control field-state" 
                            value="{{address_state}}" />
                            {{#if errors.address_state}}
                            <span class="help-text">{{errors.address_state}}</span>
                            {{/if}}
                        </div>
                    </div>
                    
                 	<div class="form-group{{#if errors.address_country}} has-error{{/if}}">
                        <label class="control-label">Country</label>
                        <div class="form-fieldset">
                        	<select name="address_country" class="form-control field-country">
                            	<option value="">Choose a Country</option>
                            	{{#each countries}}
                                <option value="{{code}}"{{#if selected}} selected{{/if}}>{{name}}</option>
                                {{/each}}
                            </select>
                            {{#if errors.address_country}}
                            <span class="help-text">{{errors.address_country}}</span>
                            {{/if}}
                        </div>
                    </div>
                    
                 	<div class="form-group{{#if errors.address_postal}} has-error{{/if}}">
                        <label class="control-label">Postal</label>
                        <div class="form-fieldset">
                            <input 
                            type="text" 
                            name="address_postal" 
                            class="form-control field-postal" 
                            value="{{address_postal}}" />
                            {{#if errors.address_postal}}
                            <span class="help-text">{{errors.address_postal}}</span>
                            {{/if}}
                        </div>
                    </div>
                 </div>
            </div>
            {{/if}}
            
            <div class="form-actions clear panel panel-default">
                <div class="panel-body">
                	{{#if checkout_terms}}
                 	<div class="form-group">
                    	<input type="hidden" name="accept" value="0" />
                 		<input type="checkbox" name="accept" value="1" />
                    	I accept the <a href="{{checkout_terms}}" target="_blank">terms</a> and willing to pay.
                    </div>
                    {{/if}}
                   <button type="submit" class="btn btn-primary">Submit</button>
               </div>
            </div>
        </div>
        <div class="col col-md-4 right">
        	<div class="panel review-panel panel-default clear">
            	<div class="panel-heading brand">
                    <div class="panel-title">Review</div>
                </div>   
                 <div class="panel-body">
                     <table class="table table-striped items">
                        <thead>
                            <tr>
                                <th class="title-item">Item</th>
                                <th class="title-currency">&nbsp;</th>
                                <th class="title-price">Price</th>
                            </tr>
                        </thead>
                        <tbody>
                            {{#each item}}
                            <tr class="item">
                                <td class="item-name">
                                	{{#if item_link}}
                                    <a href="{{item_link}}" target="_blank">{{item_name}}</a>
                                    {{else}}
                                    {{item_name}}
                                    {{/if}}
                                </td>
                                <td class="item-currency">{{../checkout_currency}}</td>
                                <td class="item-price">{{format}}</td>
                            </tr>
                            {{/each}}
                            <tr class="total">
                                <td class="total-name"><strong>Total</strong></td>
                                <td class="total-currency"><strong>{{checkout_currency}}</strong></td>
                                <td class="total-price"><strong>{{total}}</strong></td>
                            </tr>
                        </tbody>
                     </table>
                 </div>
            </div>
            
            <div class="panel submit-panel panel-default clear">
                 <div class="panel-body">
                 	{{#if checkout_terms}}
                 	<div class="form-group">
                 		<input type="checkbox" name="accept" value="1" />
                    	I accept the <a href="{{checkout_terms}}" target="_blank">terms</a> and willing to pay.
                    </div>
                    {{/if}}
                    <button type="submit" class="btn btn-primary">Submit</button>
                 </div>
            </div>
        </div>
    </div>
</form>

<script type="text/javascript">
{{#if address}}
var address = {};
{{#each address}}
address['{{@index}}'] = {
	address_street: '{{address_street}}',
	address_city: '{{address_city}}',
	address_state: '{{address_state}}',
	address_country: '{{address_country}}',
	address_postal: '{{address_postal}}' };
{{/each}}

$('select.addresses').change(function() {
	var value = $(this).val();
	var fieldset = $(this).parent().parent().parent();
	if(!value.length) {
		return;
	}
	
	console.log(value, address);
	
	$('input.field-street', fieldset).val(address[value].address_street);
	$('input.field-city', fieldset).val(address[value].address_city);
	$('input.field-state', fieldset).val(address[value].address_state);
	$('select.field-country', fieldset).val(address[value].address_country);
	$('input.field-postal', fieldset).val(address[value].address_postal);
});
{{/if}}
</script>